# Unity Pipeline Setup

This repository contains the code to setup a CI/CD system for your Unity projects.
Running the pipeline described in this repository on any repository containing a Unity project will set up the build artifact management system on Nexus and create a Jenkinsfile to be tracked in Jenkins to integrate the CI/CD in the project.
Feel free to fork/clone/use the code of the repository for your need, and consider creating a Pull Request if you made any kind of improvement to the original code, so that other might benefit from it. 

## Prerequisites

This CI/CD system uses two Open Source softwares in its architectures: **Jenkins** and **Nexus**.
The job/pipeline will run on a window node of your Jenkins infrastructure. The windows node needs:

- Python installed.
- Git installed.
- The Unity version you need to build your project, installed.

### Jenkins
In order to have the setup working correctly you will need to have a [Jenkins](https://www.jenkins.io/) instance up and running somewhere in your organization.
Jenkins must also have a GitHub account configured with the correct access set up for your repositories, and a windows node connected to its infrastructure.
Setting up Jenkins and its configurations will not be treated here.

### Nexus
In order to have the setup working correctly you will need to have a [Nexus](https://www.sonatype.com/products/sonatype-nexus-oss) instance up and running somewhere in your organization.
Setting up Nexus and its configurations will not be treated here.

## Setup

First of all it's needed to have this repository tracked as a Jenkins job in your instance of Jenkins.
Then you need to modify the URL of the three calls to the API of Nexus in the NexusSetup.bat with the address of your nexus service (in our case 192.168.0.14:8081).

This will allow you to trigger the job manually, providing the required parameters:

- HTTPS URL of the repository of your Unity project.
- Version of Unity to be used to build the project.
- The Operative Systems you want your builds for.

The pipeline will create a blob on Nexus, and two artifacts' repositories connected to it, one for the main branch of your project and one for the dev one.
**You will need to have your credentials (encoded in base64 as user:password) saved as a secret string in Jenkins as NEXUS_CREDENTIALS.**

Then it will complete Resources/JenkinsfileToFill using the choices of parameters before triggering the pipeline and using the dev/main/pr_template.
This logic is contained in the JenkinsFileSetup.py.

The final step will clone your project, paste there the Jenkinsfile and the BuildUtility.cs script to launch the builds.
It will push the changes to the created branch.
On your side you'll need to create a PR on GitHub from the PipelineSetup branch to your dev/main branch.

After merging it you can go into your Jenkins instance and track your project as a [multibranch pipeline](https://www.jenkins.io/doc/book/pipeline/multibranch/) , or whatever might work best for your needs.

## Behaviour

In this section we'll delve a bit more into the scripts, so that it will be possible to modify them to your needs or help you in finding improvement points.

### Jenkinsfile
The Jenkinsfile invokes the different scripts contained in the repository and the environment variables used in them.
You can modify the name of the nexus_credentials secret in the environment section, to match the name of the secret on your Jenkins instance.

### NexusSetup.bat
This batch script will take as input the url of the project and the credentials defined in the secrets of Jenkins and used through the environment variables of the file.
It will extract the project name from the URL.
It contains the path to your local installation of curl, that is used to send the requests to the API of Nexus to create the blob and the two repositories (dev/main).

### JenkinsFileSetup.py
This script is invoked passing to it all the parameters defined before running the job (Repository URL, Unity version, required OS builds).
This script will go through the JenkinsfileToFill and replace the comments in each section with the template present in the repository (dev_template, main_template, pr_template).
For each selected OS build, the script will substitute the environment variables referring to a specific OS inside the templates, with the correct one.
Finally it will create a Jenkinsfile with all the correct content.

### GitSetup.bat
This script takes the repository URL as input.
It modifies the url to match the ssh url of the repo, so that no password will be required to the user, as long as the GitHub account settings on Jenkins has been done correctly.
It will clone your project, move inside of it, create the branch PipelineSetup, move the Jenkinsfile generated by JenkinsFileSetup.py to the root of the project, then check for the existance of the Assets folder (**it must be at the root of the project**), and then create (if needed) the Scripts/Editor folders and move the BuildUtility.cs file inside of it.
It will add all the modifications, commit them, create the remote branch and push them to it.