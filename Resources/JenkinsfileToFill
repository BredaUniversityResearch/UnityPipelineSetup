#!groovy

def COLOR_MAP = [
	'SUCCESS': 'good', 
	'FAILURE': 'danger',
]

pipeline {
	
	environment {
		PROJECT_NAME = ""
		
		// Unity tool installation
		UNITY_EXECUTABLE = "C:\\Program Files\\Unity\\Hub\\Editor\\2020.3.31f1\\Editor\\Unity.exe"
		
		// Latest curl version installation
		CURL_EXECUTABLE = "C:\\Program Files\\Git\\mingw64\\bin\\curl.exe"

		// Unity Build params & paths
		WINDOWS_BUILD_NAME = "Windows-${currentBuild.number}"
		WINDOWS_DEV_BUILD_NAME = "Windows-Dev-${currentBuild.number}"
		MACOS_BUILD_NAME = "MacOS-${currentBuild.number}"
		MACOS_DEV_BUILD_NAME = "MacOS-Dev-${currentBuild.number}"
		
		String output = "Output"
		String outputMacDevFolder = "CurrentMacDevBuild"
		String outputWinDevFolder = "CurrentWinDevBuild"
		String outputMacFolder = "CurrentMacBuild"
		String outputWinFolder = "CurrentWinBuild"
		
		NEXUS_CREDENTIALS = credentials('NEXUS_CREDENTIALS')
	}
	
	options {
		timestamps()
    }
	
	agent {
			node {
					label 'windows'
		}
	}
	
	stages {
			stage('Clone Script') {
					steps {
						echo "Cloning the branch commit"
						checkout scm
						echo "Fetching tags"
						bat '''git fetch --all --tags'''
				}
		}
		
		stage('Build Pull Request') {
		
			when { 
					expression { env.BRANCH_NAME.startsWith('PR') }
				}
			steps {
				script {
					echo "Launching Windows Development Build..."
					bat '''"%UNITY_EXECUTABLE%" -projectPath "%CD%" -quit -batchmode -nographics -customBuildPath "%CD%\\%output%\\%outputWinDevFolder%\\%PROJECT_NAME%.exe" -customBuildName "%PROJECT_NAME%" -executeMethod BuildUtility.WindowsDevBuilder'''
				}
			}
		}
		
		stage('Build Dev Branch') {
		
			when { 
					expression { BRANCH_NAME ==~ /(dev)/ }
				}
			steps {
				script {
					echo "Launching Windows Development Build..."
					bat '''"%UNITY_EXECUTABLE%" -projectPath "%CD%" -quit -batchmode -nographics -customBuildPath "%CD%\\%output%\\%outputWinDevFolder%\\%PROJECT_NAME%.exe" -customBuildName "%PROJECT_NAME%" -executeMethod BuildUtility.WindowsDevBuilder
						echo "Zipping build..."
						7z a -tzip -r "%output%\\%WINDOWS_DEV_BUILD_NAME%" "%CD%\\%output%\\%outputWinDevFolder%\\*"
						echo "Uploading dev build artifact to Nexus..."
						"%CURL_EXECUTABLE%" -X POST "http://localhost:8081/service/rest/v1/components?repository=%PROJECT_NAME%-Dev" -H "accept: application/json" -H "Authorization: Basic %NEXUS_CREDENTIALS%" -F "raw.directory=Windows" -F "raw.asset1=@%output%\\%WINDOWS_DEV_BUILD_NAME%.zip;type=application/x-zip-compressed" -F "raw.asset1.filename=%WINDOWS_DEV_BUILD_NAME%.zip"'''
						
					echo "Launching MacOS Development Build..."
					bat '''"%UNITY_EXECUTABLE%" -projectPath "%CD%" -quit -batchmode -nographics -customBuildPath "%CD%\\%output%\\%outputMacDevFolder%\\%PROJECT_NAME%.app" -customBuildName "%PROJECT_NAME%.app" -executeMethod BuildUtility.MacOSDevBuilder
						echo "Zipping build..."
						7z a -tzip -r "%output%\\%MACOS_DEV_BUILD_NAME%" "%CD%\\%output%\\%outputMacDevFolder%\\*"
						echo "Uploading dev build artifact to Nexus..."
						"%CURL_EXECUTABLE%" -X POST "http://localhost:8081/service/rest/v1/components?repository=%PROJECT_NAME%-Dev" -H "accept: application/json" -H "Authorization: Basic %NEXUS_CREDENTIALS%" -F "raw.directory=MacOS" -F "raw.asset1=@%output%\\%MACOS_DEV_BUILD_NAME%.zip;type=application/x-zip-compressed" -F "raw.asset1.filename=%MACOS_DEV_BUILD_NAME%.zip"'''					
					}
			}
		}
		
		stage('Build Main Branch') {
		
			when { 
					expression { BRANCH_NAME ==~ /(main)/ }
				}
			steps {
				script {
					
					echo "Launching Windows Release Build..."
					bat '''"%UNITY_EXECUTABLE%" -projectPath "%CD%" -quit -batchmode -nographics -customBuildPath "%CD%\\%output%\\%outputWinFolder%\\%PROJECT_NAME%.exe" -customBuildName "%PROJECT_NAME%" -executeMethod BuildUtility.WindowsBuilder
						echo "Zipping build..."
						7z a -tzip -r "%output%\\%WINDOWS_BUILD_NAME%" "%CD%\\%output%\\%outputDevFolder%\\*"
						echo "Uploading release build artifact to Nexus..."
						"%CURL_EXECUTABLE%" -X POST "http://localhost:8081/service/rest/v1/components?repository=%PROJECT_NAME%-Main" -H "accept: application/json" -H "Authorization: Basic %NEXUS_CREDENTIALS%" -F "raw.directory=Windows" -F "raw.asset1=@%output%\\%WINDOWS_BUILD_NAME%.zip;type=application/x-zip-compressed" -F "raw.asset1.filename=%WINDOWS_BUILD_NAME%.zip"'''
						
					echo "Launching MacOS Release Build..."
					bat '''"%UNITY_EXECUTABLE%" -projectPath "%CD%" -quit -batchmode -nographics -customBuildPath "%CD%\\%output%\\%outputMacFolder%\\%PROJECT_NAME%.app" -customBuildName "%PROJECT_NAME%.app" -executeMethod BuildUtility.MacOSBuilder
						echo "Zipping build..."
						7z a -tzip -r "%output%\\%MACOS_BUILD_NAME%" "%CD%\\%output%\\%outputMacFolder%\\*"
						echo "Uploading release build artifact to Nexus..."
						"%CURL_EXECUTABLE%" -X POST "http://localhost:8081/service/rest/v1/components?repository=%PROJECT_NAME%-Main" -H "accept: application/json" -H "Authorization: Basic %NEXUS_CREDENTIALS%" -F "raw.directory=MacOS" -F "raw.asset1=@%output%\\%MACOS_BUILD_NAME%.zip;type=application/x-zip-compressed" -F "raw.asset1.filename=%MACOS_BUILD_NAME%.zip"'''
				}
			}
		}
	}
	post {
			always {
					echo "Cleaning up workspace..."
					bat '''RMDIR %output% /S /Q'''
					
					slackSend color: COLOR_MAP[currentBuild.currentResult],
					message: "*${currentBuild.currentResult}:* Job ${env.JOB_NAME} build ${env.BUILD_NUMBER}\n More info at: ${env.BUILD_URL}"
			}
		}
}